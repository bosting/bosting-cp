#!/usr/bin/env ruby

APP_PATH = '/home/bosting/bosting-cp'.freeze
BUNDLE_PATH = 'bundle'.freeze
UNICORN_RAILS_PATH = 'unicorn_rails'.freeze
RAILS_ENV = 'production'.freeze

class Runner
  class << self
    def start
      system "#{BUNDLE_PATH} exec #{UNICORN_RAILS_PATH} -c #{APP_PATH}/config/unicorn.rb -E #{RAILS_ENV} -D"
    end

    def reload
      system "kill -s USR2 #{pid}"
    end

    def restart
      stop
      start
    end

    def graceful_stop
      system "kill -s QUIT #{pid}"
    end

    def stop
      system "kill #{pid}"
    end

    def status
      exit begin
             Process.getpgid(pid.to_i)
             puts 'Unicorn is running'
             0
           rescue Errno::ESRCH, Errno::ENOENT
             puts 'Unicorn is not running'
             1
           end
    end

    def pid
      File.read "#{APP_PATH}/tmp/pids/unicorn.pid"
    end
  end
end

action = ARGV[0]
actions = %w(start reload restart graceful_stop stop status)
if actions.include?(action)
  Runner.send(action)
else
  STDERR.puts "usage: ./bin/unicorn [#{actions.join('|')}]"
  exit(1)
end
